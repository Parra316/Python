"""
================================================================================
FUNDAMENTOS DE CIBERSEGURIDAD CON PYTHON
================================================================================

IMPORTANTE - ÉTICA Y LEGALIDAD:
------------------------------
- Solo realizar pruebas en sistemas que tengas autorización
- Obtener permiso por escrito antes de cualquier prueba
- Las técnicas aquí son para aprendizaje y defensa
- El hacking no autorizado es ilegal y tiene consecuencias graves

ÁREAS DE CIBERSEGURIDAD:
-----------------------
1. Pentesting (Pruebas de penetración)
2. Análisis de vulnerabilidades
3. Seguridad de aplicaciones
4. Análisis de malware
5. Forense digital
6. Seguridad de redes

PYTHON EN SEGURIDAD:
-------------------
- Automatización de tareas de seguridad
- Desarrollo de herramientas
- Scripts de análisis
- Automatización de auditorías

================================================================================
"""

import hashlib
import secrets
import base64
from urllib.parse import urlparse
import re

# ==============================================================================
# CRIPTOGRAFÍA BÁSICA
# ==============================================================================

print("=" * 60)
print("CRIPTOGRAFÍA BÁSICA")
print("=" * 60)

print("""
La criptografía protege información mediante cifrado.

CONCEPTOS CLAVE:
- Hash: Función unidireccional (no se puede revertir)
- Cifrado simétrico: Misma clave para cifrar y descifrar
- Cifrado asimétrico: Clave pública y privada
- Salt: Datos aleatorios añadidos antes de hashear
""")

# FUNCIONES HASH
print("\n--- Funciones Hash ---")

def demostrar_hashes(texto):
    """Muestra diferentes algoritmos de hash."""
    datos = texto.encode('utf-8')

    hashes = {
        'MD5': hashlib.md5(datos).hexdigest(),
        'SHA-1': hashlib.sha1(datos).hexdigest(),
        'SHA-256': hashlib.sha256(datos).hexdigest(),
        'SHA-512': hashlib.sha512(datos).hexdigest()[:64] + '...'
    }

    print(f"Texto: '{texto}'")
    for nombre, valor in hashes.items():
        print(f"  {nombre}: {valor}")


demostrar_hashes("contraseña123")

print("\n⚠️  MD5 y SHA-1 NO son seguros para contraseñas")
print("✓  Usar bcrypt, scrypt, o Argon2 para contraseñas")


# HASH DE CONTRASEÑAS SEGURO
print("\n--- Hash de Contraseñas (manera segura) ---")

def hash_password_simple(password, salt=None):
    """
    Hash de contraseña con salt.
    NOTA: En producción usar bcrypt o argon2.
    """
    if salt is None:
        salt = secrets.token_hex(16)

    # Combinar password y salt
    salted = (password + salt).encode('utf-8')

    # Hash múltiple (key stretching básico)
    hash_result = hashlib.sha256(salted).hexdigest()
    for _ in range(10000):
        hash_result = hashlib.sha256(hash_result.encode()).hexdigest()

    return f"{salt}${hash_result}"


def verificar_password(password, hash_guardado):
    """Verifica si la contraseña coincide con el hash."""
    salt = hash_guardado.split('$')[0]
    nuevo_hash = hash_password_simple(password, salt)
    return secrets.compare_digest(nuevo_hash, hash_guardado)


# Ejemplo
password = "mi_contraseña_segura"
hash_guardado = hash_password_simple(password)
print(f"Hash guardado: {hash_guardado[:50]}...")
print(f"Verificación correcta: {verificar_password(password, hash_guardado)}")
print(f"Verificación incorrecta: {verificar_password('otra', hash_guardado)}")


# ==============================================================================
# GENERACIÓN DE DATOS SEGUROS
# ==============================================================================

print("\n" + "=" * 60)
print("GENERACIÓN DE DATOS SEGUROS")
print("=" * 60)

print("""
El módulo 'secrets' genera datos criptográficamente seguros.
NUNCA usar 'random' para seguridad.
""")

# Tokens seguros
print("\n--- Tokens y contraseñas ---")
print(f"Token hex (32 bytes): {secrets.token_hex(32)}")
print(f"Token URL-safe: {secrets.token_urlsafe(32)}")
print(f"Número aleatorio: {secrets.randbelow(1000000)}")


def generar_password(longitud=16, incluir_especiales=True):
    """Genera una contraseña segura."""
    import string

    caracteres = string.ascii_letters + string.digits
    if incluir_especiales:
        caracteres += "!@#$%^&*()_+-="

    # Asegurar al menos uno de cada tipo
    password = [
        secrets.choice(string.ascii_lowercase),
        secrets.choice(string.ascii_uppercase),
        secrets.choice(string.digits),
    ]
    if incluir_especiales:
        password.append(secrets.choice("!@#$%^&*()_+-="))

    # Completar longitud
    password += [secrets.choice(caracteres) for _ in range(longitud - len(password))]

    # Mezclar
    secrets.SystemRandom().shuffle(password)
    return ''.join(password)


print(f"\nContraseña generada: {generar_password(20)}")


# ==============================================================================
# VALIDACIÓN DE ENTRADA
# ==============================================================================

print("\n" + "=" * 60)
print("VALIDACIÓN DE ENTRADA (Prevención de ataques)")
print("=" * 60)

print("""
La validación de entrada previene ataques como:
- SQL Injection
- XSS (Cross-Site Scripting)
- Command Injection
- Path Traversal
""")


def validar_email(email):
    """Valida formato de email."""
    patron = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return bool(re.match(patron, email))


def sanitizar_input(texto):
    """
    Sanitiza entrada para prevenir XSS básico.
    En producción usar librerías especializadas.
    """
    # Escapar caracteres HTML
    reemplazos = {
        '<': '&lt;',
        '>': '&gt;',
        '&': '&amp;',
        '"': '&quot;',
        "'": '&#x27;'
    }
    for char, escape in reemplazos.items():
        texto = texto.replace(char, escape)
    return texto


def validar_url(url):
    """Valida y analiza una URL."""
    try:
        resultado = urlparse(url)
        es_valida = all([resultado.scheme, resultado.netloc])

        if es_valida:
            return {
                'valida': True,
                'esquema': resultado.scheme,
                'dominio': resultado.netloc,
                'ruta': resultado.path,
                'es_https': resultado.scheme == 'https'
            }
        return {'valida': False}
    except Exception:
        return {'valida': False}


# Ejemplos
print("\n--- Validación de emails ---")
emails = ['usuario@ejemplo.com', 'invalido@', 'test@dominio.org']
for email in emails:
    print(f"  {email}: {'✓' if validar_email(email) else '✗'}")

print("\n--- Sanitización de input ---")
texto_malicioso = '<script>alert("XSS")</script>'
print(f"  Original: {texto_malicioso}")
print(f"  Sanitizado: {sanitizar_input(texto_malicioso)}")

print("\n--- Validación de URLs ---")
urls = ['https://ejemplo.com/pagina', 'http://inseguro.com', 'no-es-url']
for url in urls:
    resultado = validar_url(url)
    status = '✓ HTTPS' if resultado.get('es_https') else ('✓ HTTP' if resultado.get('valida') else '✗')
    print(f"  {url}: {status}")


# ==============================================================================
# ANÁLISIS DE SEGURIDAD BÁSICO
# ==============================================================================

print("\n" + "=" * 60)
print("ANÁLISIS DE SEGURIDAD BÁSICO")
print("=" * 60)


def analizar_password_strength(password):
    """
    Analiza la fortaleza de una contraseña.
    """
    puntuacion = 0
    feedback = []

    # Longitud
    if len(password) >= 8:
        puntuacion += 1
    else:
        feedback.append("Muy corta (mínimo 8 caracteres)")

    if len(password) >= 12:
        puntuacion += 1

    if len(password) >= 16:
        puntuacion += 1

    # Complejidad
    if re.search(r'[a-z]', password):
        puntuacion += 1
    else:
        feedback.append("Añadir minúsculas")

    if re.search(r'[A-Z]', password):
        puntuacion += 1
    else:
        feedback.append("Añadir mayúsculas")

    if re.search(r'\d', password):
        puntuacion += 1
    else:
        feedback.append("Añadir números")

    if re.search(r'[!@#$%^&*(),.?":{}|<>]', password):
        puntuacion += 1
    else:
        feedback.append("Añadir caracteres especiales")

    # Patrones comunes (malo)
    patrones_malos = ['123', 'abc', 'qwerty', 'password', 'admin']
    for patron in patrones_malos:
        if patron.lower() in password.lower():
            puntuacion -= 2
            feedback.append(f"Contiene patrón común: {patron}")

    # Evaluación
    if puntuacion <= 2:
        nivel = "Muy débil"
    elif puntuacion <= 4:
        nivel = "Débil"
    elif puntuacion <= 6:
        nivel = "Moderada"
    else:
        nivel = "Fuerte"

    return {
        'puntuacion': max(0, puntuacion),
        'nivel': nivel,
        'feedback': feedback
    }


# Probar contraseñas
print("\n--- Análisis de contraseñas ---")
passwords_test = ['123456', 'Password1', 'Tr0ub4dor&3', 'correct-horse-battery-staple']

for pwd in passwords_test:
    resultado = analizar_password_strength(pwd)
    print(f"\n  '{pwd}'")
    print(f"    Nivel: {resultado['nivel']} ({resultado['puntuacion']}/7)")
    if resultado['feedback']:
        for f in resultado['feedback']:
            print(f"    - {f}")


# ==============================================================================
# HERRAMIENTAS DE SEGURIDAD EN PYTHON
# ==============================================================================

print("\n" + "=" * 60)
print("HERRAMIENTAS Y LIBRERÍAS DE SEGURIDAD")
print("=" * 60)

print("""
LIBRERÍAS RECOMENDADAS:
----------------------

CRIPTOGRAFÍA:
  pip install cryptography  # Cifrado robusto
  pip install bcrypt        # Hash de contraseñas
  pip install PyNaCl        # Criptografía moderna

ANÁLISIS DE RED:
  pip install scapy         # Manipulación de paquetes
  pip install python-nmap   # Escaneo de puertos

WEB SECURITY:
  pip install requests      # Peticiones HTTP
  pip install beautifulsoup4 # Parsing HTML

FORENSE:
  pip install volatility3   # Análisis de memoria
  pip install pefile        # Análisis de PE (Windows)

FRAMEWORKS:
  Metasploit (Ruby, pero tiene API Python)
  Burp Suite (extensiones en Python)

APRENDIZAJE:
  - HackTheBox, TryHackMe (plataformas de práctica)
  - OWASP Top 10 (vulnerabilidades web)
  - CTF (Capture The Flag)
""")


# ==============================================================================
# EJEMPLO: ESCÁNER DE PUERTOS SIMPLE
# ==============================================================================

print("\n" + "=" * 60)
print("EJEMPLO: Escáner de puertos simple")
print("=" * 60)

print("""
NOTA: Solo usar en redes/sistemas propios o con autorización.
""")

import socket


def escanear_puerto(host, puerto, timeout=1):
    """
    Verifica si un puerto está abierto.
    """
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(timeout)
        resultado = sock.connect_ex((host, puerto))
        sock.close()
        return resultado == 0
    except socket.error:
        return False


def escanear_puertos_comunes(host):
    """
    Escanea puertos comunes.
    SOLO usar en sistemas propios o con autorización.
    """
    puertos_comunes = {
        21: 'FTP',
        22: 'SSH',
        23: 'Telnet',
        25: 'SMTP',
        80: 'HTTP',
        443: 'HTTPS',
        3306: 'MySQL',
        5432: 'PostgreSQL',
        6379: 'Redis',
        8080: 'HTTP-Alt'
    }

    print(f"\nEscaneando {host}...")
    print("-" * 40)

    for puerto, servicio in puertos_comunes.items():
        if escanear_puerto(host, puerto):
            print(f"  Puerto {puerto} ({servicio}): ABIERTO")

    print("-" * 40)


# Ejemplo con localhost (seguro)
print("Escaneando localhost (127.0.0.1):")
escanear_puertos_comunes('127.0.0.1')

print("\n" + "=" * 60)
print("PRÓXIMO: Análisis de malware (en entorno controlado)")
print("=" * 60)
